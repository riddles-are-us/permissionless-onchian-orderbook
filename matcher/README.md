# OrderBook Matcher

åŸºäº Rust çš„é“¾ä¸‹æ’®åˆå¼•æ“ï¼Œç”¨äº OrderBook å»ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ”„ **äº‹ä»¶é©±åŠ¨åŒæ­¥**ï¼šé€šè¿‡é“¾ä¸Šäº‹ä»¶å®æ—¶æ›´æ–°æœ¬åœ°è®¢å•ç°¿çŠ¶æ€
- ğŸ¯ **ç²¾ç¡®æ¨¡æ‹Ÿ**ï¼š`OrderBookSimulator` ä¸¥æ ¼é•œåƒé“¾ä¸Šè®¢å•ç°¿ç»“æ„
- ğŸ“¦ **æ‰¹é‡å¤„ç†**ï¼šæ‰¹é‡è°ƒç”¨é“¾ä¸Š `batchProcessRequests` APIï¼ŒèŠ‚çœ gas
- âš¡ **é«˜æ€§èƒ½**ï¼šä½¿ç”¨æ·±æ‹·è´éš”ç¦»æ¨¡æ‹Ÿè®¡ç®—ï¼Œä¿è¯çŠ¶æ€ä¸€è‡´æ€§
- ğŸ“Š **å®æ—¶ç›‘æ§**ï¼šå®Œæ•´çš„æ—¥å¿—ç³»ç»Ÿï¼Œç›‘æ§åŒ¹é…å¼•æ“è¿è¡ŒçŠ¶æ€

## æ¶æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Matcher                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ StateSynchronizerâ”‚    â”‚      MatchingEngine             â”‚ â”‚
â”‚  â”‚                 â”‚    â”‚                                 â”‚ â”‚
â”‚  â”‚ â€¢ å¯åŠ¨æ—¶åŒæ­¥çŠ¶æ€  â”‚    â”‚ â€¢ å®šæœŸå¤„ç†è¯·æ±‚é˜Ÿåˆ—               â”‚ â”‚
â”‚  â”‚ â€¢ ç›‘å¬é“¾ä¸Šäº‹ä»¶   â”‚    â”‚ â€¢ è®¡ç®— insertAfterPrice         â”‚ â”‚
â”‚  â”‚ â€¢ æ›´æ–° GlobalStateâ”‚   â”‚ â€¢ æ‰§è¡Œæ‰¹é‡äº¤æ˜“                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚           â”‚                          â”‚                       â”‚
â”‚           â–¼                          â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    GlobalState                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ queued_requests  â”‚  â”‚      orderbook             â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ (Sequenceré˜Ÿåˆ—)   â”‚  â”‚   (OrderBookSimulator)     â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                  â”‚  â”‚  â€¢ ask_head/tail           â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                  â”‚  â”‚  â€¢ bid_head/tail           â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                  â”‚  â”‚  â€¢ price_levels: HashMap   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                  â”‚  â”‚  â€¢ orders: HashMap         â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

```
é“¾ä¸Šäº‹ä»¶                    æœ¬åœ°çŠ¶æ€                    äº¤æ˜“æ‰§è¡Œ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PlaceOrderRequested â”€â”€â”€â”€â”€â”€â–º queued_requests.add()
                                    â”‚
                                    â–¼
                           MatchingEngine.process_batch()
                                    â”‚
                           clone_orderbook() â”€â”€â–º æ·±æ‹·è´
                                    â”‚
                           simulate_insert() â”€â”€â–º è®¡ç®— insertAfterPrice
                                    â”‚
                           execute_batch() â”€â”€â”€â–º batchProcessRequests tx
                                    â”‚
                                    â–¼
OrderInserted â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º orderbook.orders.insert()
PriceLevelCreated â”€â”€â”€â”€â”€â”€â”€â”€â–º orderbook.price_levels.insert()
OrderFilled â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º orderbook.orders.update()
OrderRemoved â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º orderbook.orders.remove()
```

### å…³é”®è®¾è®¡

1. **äº‹ä»¶é©±åŠ¨çŠ¶æ€æ›´æ–°**
   - `GlobalState.orderbook` åªé€šè¿‡é“¾ä¸Šäº‹ä»¶æ›´æ–°
   - ä¿è¯æœ¬åœ°çŠ¶æ€ä¸é“¾ä¸Šä¸¥æ ¼ä¸€è‡´

2. **æ·±æ‹·è´éš”ç¦»æ¨¡æ‹Ÿ**
   - `clone_orderbook()` åˆ›å»ºå®Œæ•´æ·±æ‹·è´
   - æ¨¡æ‹Ÿè®¡ç®—ä¸å½±å“åŸå§‹çŠ¶æ€
   - äº¤æ˜“å¤±è´¥æ—¶çŠ¶æ€è‡ªåŠ¨ä¿æŒæ­£ç¡®

3. **è¯·æ±‚é˜Ÿåˆ—ç®¡ç†**
   - åªæœ‰äº¤æ˜“æˆåŠŸåæ‰ç§»é™¤è¯·æ±‚
   - å¤±è´¥æ—¶è¯·æ±‚ä¿ç•™ï¼Œä¸‹è½®é‡è¯•

## å¿«é€Ÿå¼€å§‹

### æœ¬åœ°æµ‹è¯•

```bash
# 1. å¯åŠ¨ Anvil
anvil --block-time 1

# 2. éƒ¨ç½²åˆçº¦
forge script script/Deploy.s.sol --broadcast --rpc-url http://127.0.0.1:8545

# 3. ä¸‹æµ‹è¯•è®¢å•
forge script script/PlaceTestOrders.s.sol --broadcast --rpc-url http://127.0.0.1:8545

# 4. è¿è¡Œ Matcher
cd matcher
cargo run -- -l debug
```

### é…ç½®æ–‡ä»¶

ç¼–è¾‘ `config.toml`ï¼š

```toml
[network]
rpc_url = "ws://127.0.0.1:8545"
chain_id = 31337

[contracts]
sequencer = "0x..."
orderbook = "0x..."
account = "0x..."

[matching]
max_batch_size = 10
matching_interval_ms = 3000

[executor]
private_key = "0x..."
gas_price_gwei = 1
gas_limit = 5000000
```

### å‘½ä»¤è¡Œå‚æ•°

```
Options:
  -c, --config <CONFIG>        é…ç½®æ–‡ä»¶è·¯å¾„ [default: config.toml]
  -l, --log-level <LOG_LEVEL>  æ—¥å¿—çº§åˆ« [default: info]
  -h, --help                   æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
```

## é¡¹ç›®ç»“æ„

```
matcher/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.rs               # ä¸»å…¥å£
â”‚   â”œâ”€â”€ config.rs             # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ contracts.rs          # åˆçº¦ç»‘å®š
â”‚   â”œâ”€â”€ types.rs              # ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ state.rs              # GlobalState çŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ sync.rs               # çŠ¶æ€åŒæ­¥å™¨ + äº‹ä»¶ç›‘å¬
â”‚   â”œâ”€â”€ matcher.rs            # åŒ¹é…å¼•æ“
â”‚   â””â”€â”€ orderbook_simulator.rs # è®¢å•ç°¿æ¨¡æ‹Ÿå™¨
â”œâ”€â”€ abi/                      # åˆçº¦ ABI æ–‡ä»¶
â”œâ”€â”€ Cargo.toml
â””â”€â”€ config.toml
```

## ç›‘å¬çš„äº‹ä»¶

| äº‹ä»¶ | æ¥æº | å¤„ç† |
|------|------|------|
| `PlaceOrderRequested` | Sequencer | æ·»åŠ åˆ°è¯·æ±‚é˜Ÿåˆ— |
| `RemoveOrderRequested` | Sequencer | æ·»åŠ åˆ°è¯·æ±‚é˜Ÿåˆ— |
| `OrderInserted` | OrderBook | æ›´æ–° simulator.orders |
| `PriceLevelCreated` | OrderBook | æ›´æ–° simulator.price_levels |
| `PriceLevelRemoved` | OrderBook | ä» simulator ç§»é™¤ |
| `OrderFilled` | OrderBook | æ›´æ–°è®¢å• filled_amount |
| `OrderRemoved` | OrderBook | ä» simulator ç§»é™¤ |
| `Trade` | OrderBook | è®°å½•äº¤æ˜“æ—¥å¿— |

## æ—¥å¿—ç¤ºä¾‹

```
ğŸš€ Starting OrderBook Matcher
ğŸ“‹ Configuration loaded
ğŸ”„ Starting state synchronizer
ğŸ“š Syncing historical state at block 100
ğŸ“Š Trading pair: askHead=201, bidHead=200
âœ… Historical state synced at block 100
ğŸ‘€ Watching for OrderBook and Sequencer events from block 100
ğŸ“¡ Starting OrderBook event listener from block 100
ğŸ“¡ Starting Sequencer event listener from block 100
ğŸ¯ Starting matching engine
ğŸ“¥ PlaceOrderRequested: requestId=11, price=199500000000, isAsk=false
ğŸ“Š Simulator state: ask_head=201, bid_head=200, 10 price_levels, 10 orders
PlaceOrder 11 (price=199500000000, is_ask=false): insertAfterPrice=200000000000
ğŸ“¤ Executing batch with 1 orders
ğŸ“ Transaction sent: 0xabc...
ğŸ“¦ OrderInserted: orderId=11, price=199500000000, amount=20000000, isAsk=false
ğŸ“Š PriceLevelCreated: price=199500000000, isAsk=false
âœ… Transaction confirmed, 4 events emitted
âœ¨ Processed 1 requests
```

## å®‰å…¨æ³¨æ„äº‹é¡¹

âš ï¸ **ç§é’¥**ï¼šç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–å¯†é’¥ç®¡ç†ç³»ç»Ÿ

âš ï¸ **Gas**ï¼šæ‰¹é‡å¤„ç†ä¼šæ¶ˆè€—è¾ƒå¤š gasï¼Œå»ºè®®å…ˆæµ‹è¯•

âš ï¸ **ç½‘ç»œ**ï¼šWebSocket è¿æ¥å¯èƒ½ä¸­æ–­ï¼Œå†…ç½®é‡è¿æœºåˆ¶

## License

MIT
