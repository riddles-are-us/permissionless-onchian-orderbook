# é“¾ä¸Šè®¢å•ç°¿ç³»ç»Ÿ (On-Chain Order Book System)

## ç³»ç»Ÿæ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªå®Œå…¨å»ä¸­å¿ƒåŒ–çš„é“¾ä¸Šè®¢å•ç°¿ç³»ç»Ÿï¼Œé€šè¿‡ **Sequencer** æœºåˆ¶ç¡®ä¿è®¢å•æ’å…¥çš„å…¬å¹³æ€§å’Œé¡ºåºæ€§ã€‚

## æ ¸å¿ƒç‰¹æ€§

- âœ… **å…¬å¹³æ’åº**: é€šè¿‡é“¾ä¸ŠSequencerä¿è¯è®¢å•çš„å…ˆæ¥å…ˆæœåŠ¡(FIFO)
- âœ… **Gasä¼˜åŒ–**: é“¾ä¸‹è®¡ç®—æ’å…¥ä½ç½®ï¼Œé“¾ä¸ŠåªåšéªŒè¯
- âœ… **åŒå±‚é“¾è¡¨**: ä»·æ ¼å±‚çº§é“¾è¡¨ + è®¢å•é“¾è¡¨çš„é«˜æ•ˆè®¾è®¡
- âœ… **å¸‚ä»·å•æ”¯æŒ**: åŒæ—¶æ”¯æŒé™ä»·å•å’Œå¸‚ä»·å•
- âœ… **ä¸¥æ ¼éªŒè¯**: ç¡®ä¿ä»·æ ¼æ’åºå’Œæ’å…¥ä½ç½®çš„æ­£ç¡®æ€§

## æ¶æ„è®¾è®¡

### 1. Sequencer.sol - è®¢å•æ’åºå™¨

**èŒè´£**: ç®¡ç†è®¢å•æäº¤é¡ºåºï¼Œç¡®ä¿å…¬å¹³æ€§

**æ ¸å¿ƒæµç¨‹**:
```
ç”¨æˆ·æäº¤è®¢å• â†’ Sequenceræ’é˜Ÿ â†’ éªŒè¯å¤´éƒ¨è®¢å• â†’ æ’å…¥OrderBook â†’ ä»Sequencerå¼¹å‡º
```

**ä¸»è¦API**:

#### `placeLimitOrder()` - æäº¤é™ä»·å•
```solidity
function placeLimitOrder(
    bytes32 tradingPair,  // äº¤æ˜“å¯¹ï¼Œå¦‚ keccak256("ETH/USDC")
    bool isAsk,           // true=å–å•, false=ä¹°å•
    uint256 price,        // ä»·æ ¼
    uint256 amount        // æ•°é‡
) external returns (uint256 orderId)
```

#### `placeMarketOrder()` - æäº¤å¸‚ä»·å•
```solidity
function placeMarketOrder(
    bytes32 tradingPair,
    bool isAsk,
    uint256 amount
) external returns (uint256 orderId)
```

#### `requestRemoveOrder()` - è¯·æ±‚ç§»é™¤è®¢å•
```solidity
function requestRemoveOrder(
    uint256 orderIdToRemove  // è¦ç§»é™¤çš„è®¢å•ID
) external returns (uint256 requestId)
```

**åŠŸèƒ½**:
- æäº¤æ’¤å•è¯·æ±‚åˆ°é˜Ÿåˆ—
- éªŒè¯è®¢å•å­˜åœ¨äº OrderBook ä¸­
- éµå¾ª FIFO åŸåˆ™ï¼Œç¡®ä¿æ’¤å•çš„å…¬å¹³æ€§
- è¿”å›è¯·æ±‚ ID ç”¨äºè¿½è¸ªå¤„ç†çŠ¶æ€

**æµç¨‹**:
1. ç”¨æˆ·è°ƒç”¨ `requestRemoveOrder(orderId)`
2. Sequencer éªŒè¯è®¢å•å­˜åœ¨
3. åˆ›å»º RemoveOrder ç±»å‹çš„è¯·æ±‚
4. è¯·æ±‚è¿›å…¥é˜Ÿåˆ—ç­‰å¾…å¤„ç†
5. Matcher å¤„ç†æ—¶ä¼šè°ƒç”¨ OrderBook.removeOrder()

#### `popOrder()` - å¼¹å‡ºè®¢å•ï¼ˆä»…OrderBookå¯è°ƒç”¨ï¼‰
```solidity
function popOrder(uint256 orderId) external onlyOrderBook
```

#### `isHeadOrder()` - éªŒè¯æ˜¯å¦ä¸ºé˜Ÿåˆ—å¤´éƒ¨
```solidity
function isHeadOrder(uint256 orderId) external view returns (bool)
```

### 2. OrderBook.sol - è®¢å•ç°¿

**èŒè´£**: ç®¡ç†è®¢å•ç°¿çš„åŒå‘é“¾è¡¨ç»“æ„

**æ•°æ®ç»“æ„**:

```
OrderBookData {
    é™ä»·Askåˆ—è¡¨ (å¤´â†’å°¾: ä»·æ ¼é€’å¢)
    é™ä»·Bidåˆ—è¡¨ (å¤´â†’å°¾: ä»·æ ¼é€’å‡)
    å¸‚ä»·Askåˆ—è¡¨ (FIFO)
    å¸‚ä»·Bidåˆ—è¡¨ (FIFO)
}

æ¯ä¸ªä»·æ ¼å±‚çº§åŒ…å«:
- ä»·æ ¼
- è¯¥ä»·æ ¼ä¸‹çš„è®¢å•é“¾è¡¨
- æ€»æŒ‚å•é‡
```

**ä¸»è¦API**:

#### `insertOrder()` - æ’å…¥é™ä»·å•
```solidity
function insertOrder(
    uint256 sequencerOrderId,      // Sequencerä¸­çš„è®¢å•ID
    uint256 insertAfterPriceLevel, // åœ¨å“ªä¸ªä»·æ ¼å±‚çº§ä¹‹åæ’å…¥ (0=å¤´éƒ¨)
    uint256 insertAfterOrder       // åœ¨å“ªä¸ªè®¢å•ä¹‹åæ’å…¥ (0=è¯¥ä»·æ ¼å±‚çº§å¤´éƒ¨)
) external
```

**éªŒè¯é€»è¾‘**:
1. éªŒè¯è®¢å•æ˜¯Sequenceré˜Ÿåˆ—å¤´éƒ¨
2. ä»Sequencerè·å–è®¢å•ä¿¡æ¯
3. éªŒè¯ä»·æ ¼æ’åºï¼ˆAské€’å¢/Bidé€’å‡ï¼‰
4. æ’å…¥è®¢å•
5. ä»Sequencerå¼¹å‡º

#### `insertMarketOrder()` - æ’å…¥å¸‚ä»·å•
```solidity
function insertMarketOrder(
    uint256 sequencerOrderId  // Sequencerä¸­çš„è®¢å•ID
) external
```

**è¯´æ˜**ï¼š
- å¸‚ä»·å•æ€»æ˜¯æ’å…¥åˆ°é˜Ÿå°¾ï¼Œä¿è¯ FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰
- ä¸éœ€è¦æä¾›æ’å…¥ä½ç½®ï¼Œç®€åŒ– API å¹¶èŠ‚çœ gas

#### `removeOrder()` - åˆ é™¤é™ä»·å•
```solidity
function removeOrder(
    bytes32 tradingPair,
    uint256 orderId,
    bool isAsk
) external
```

#### `removeMarketOrder()` - åˆ é™¤å¸‚ä»·å•
```solidity
function removeMarketOrder(
    bytes32 tradingPair,
    uint256 orderId,
    bool isAsk
) external
```

## ä½¿ç”¨æµç¨‹ç¤ºä¾‹

### å®Œæ•´æµç¨‹ï¼šæäº¤å¹¶æ’å…¥é™ä»·å•

```solidity
// 1. éƒ¨ç½²åˆçº¦
Sequencer sequencer = new Sequencer();
OrderBook orderBook = new OrderBook();
Account account = new Account();

// 2. é…ç½®åˆçº¦å…³ç³»
sequencer.setOrderBook(address(orderBook));
sequencer.setAccount(address(account));
orderBook.setSequencer(address(sequencer));
orderBook.setAccount(address(account));
account.setSequencer(address(sequencer));
account.setOrderBook(address(orderBook));

// 3. æ³¨å†Œäº¤æ˜“å¯¹
bytes32 pair = keccak256("WETH/USDC");
account.registerTradingPair(pair, wethAddress, usdcAddress);

// 4. ç”¨æˆ·å……å€¼
account.deposit(wethAddress, 10 ether);
account.deposit(usdcAddress, 10000 * 10**6);

// 5. ç”¨æˆ·æäº¤é™ä»·å•åˆ° Sequencerï¼ˆå¸¦ç²¾åº¦ï¼‰
(uint256 requestId1, uint256 orderId1) = sequencer.placeLimitOrder(
    pair,
    false,              // bid (ä¹°å•)
    2000 * 10**8,      // price with PRICE_DECIMALS
    1 * 10**8          // amount with AMOUNT_DECIMALS
);

(uint256 requestId2, uint256 orderId2) = sequencer.placeLimitOrder(
    pair,
    false,
    1950 * 10**8,
    1 * 10**8
);

(uint256 requestId3, uint256 orderId3) = sequencer.placeLimitOrder(
    pair,
    false,
    1900 * 10**8,
    1 * 10**8
);

// 6. é“¾ä¸‹ Matcher è®¡ç®—æ’å…¥ä½ç½®
// Matcher ç›‘æ§ Sequencer é˜Ÿåˆ—ï¼Œè®¡ç®—æ¯ä¸ªè®¢å•çš„æ­£ç¡®æ’å…¥ä½ç½®
// å¯¹äº bidï¼ˆä¹°å•ï¼‰ï¼Œä»·æ ¼ä»é«˜åˆ°ä½æ’åºï¼š2000 > 1950 > 1900

// 7. Matcher æ‰¹é‡å¤„ç†è¯·æ±‚
uint256[] memory orderIds = new uint256[](3);
orderIds[0] = orderId1;
orderIds[1] = orderId2;
orderIds[2] = orderId3;

uint256[] memory insertAfterPriceLevels = new uint256[](3);
insertAfterPriceLevels[0] = 0;  // 2000 æ’å…¥åˆ° bid å¤´éƒ¨ï¼ˆåˆ›å»ºæ–°ä»·æ ¼å±‚çº§ï¼‰
insertAfterPriceLevels[1] = 1;  // 1950 æ’å…¥åˆ°ä»·æ ¼å±‚çº§ 1 ä¹‹å
insertAfterPriceLevels[2] = 2;  // 1900 æ’å…¥åˆ°ä»·æ ¼å±‚çº§ 2 ä¹‹å

uint256[] memory insertAfterOrders = new uint256[](3);
insertAfterOrders[0] = 0;  // åœ¨æ–°ä»·æ ¼å±‚çº§çš„å¤´éƒ¨
insertAfterOrders[1] = 0;  // åœ¨æ–°ä»·æ ¼å±‚çº§çš„å¤´éƒ¨
insertAfterOrders[2] = 0;  // åœ¨æ–°ä»·æ ¼å±‚çº§çš„å¤´éƒ¨

orderBook.batchProcessRequests(
    orderIds,
    insertAfterPriceLevels,
    insertAfterOrders
);

// è®¢å•ç°åœ¨å·²ç»åœ¨ OrderBook ä¸­ï¼Œèµ„é‡‘å·²é”å®šï¼Œå¹¶å·²ä» Sequencer é˜Ÿåˆ—ä¸­ç§»é™¤
```

**å…³é”®ç‚¹**:
- `insertAfterPriceLevel = 0` è¡¨ç¤ºåœ¨è¯¥ä»·æ ¼çš„è®¢å•ä¹‹å‰æ’å…¥ï¼ˆå¦‚æœæ˜¯ç¬¬ä¸€ä¸ªè®¢å•ï¼Œåˆ™åˆ›å»ºæ–°çš„ä»·æ ¼å±‚çº§åœ¨å¤´éƒ¨ï¼‰
- `insertAfterPriceLevel = N` è¡¨ç¤ºåœ¨ä»·æ ¼å±‚çº§ N ä¹‹åæ’å…¥ï¼ˆå¦‚æœä»·æ ¼ç›¸åŒåˆ™æ’å…¥åˆ°åŒä¸€å±‚çº§ï¼Œå¦åˆ™åˆ›å»ºæ–°å±‚çº§ï¼‰
- `insertAfterOrder = 0` è¡¨ç¤ºæ’å…¥åˆ°è¯¥ä»·æ ¼å±‚çº§çš„å¤´éƒ¨
- `insertAfterOrder = M` è¡¨ç¤ºåœ¨è®¢å• M ä¹‹åæ’å…¥ï¼ˆåŒä¸€ä»·æ ¼å±‚çº§å†…æŒ‰æ—¶é—´æ’åºï¼‰

### åˆ é™¤è®¢å•

```solidity
// ç”¨æˆ·è¯·æ±‚åˆ é™¤è®¢å•ï¼ˆé€šè¿‡ Sequencer ç¡®ä¿ FIFOï¼‰
uint256 removeRequestId = sequencer.requestRemoveOrder(orderId);

// Matcher ä¼šè‡ªåŠ¨å¤„ç†è¿™ä¸ªç§»é™¤è¯·æ±‚
// å½“ removeRequestId æˆä¸ºé˜Ÿåˆ—å¤´éƒ¨æ—¶ï¼ŒMatcher è°ƒç”¨ï¼š
// orderBook.removeOrder(orderId)
// è®¢å•è¢«ç§»é™¤ï¼Œé”å®šèµ„é‡‘è§£é”è¿”è¿˜ç»™ç”¨æˆ·
```

**æ³¨æ„**:
- è®¢å•ç§»é™¤ä¹Ÿå¿…é¡»é€šè¿‡ Sequencer é˜Ÿåˆ—ï¼Œéµå¾ª FIFO åŸåˆ™
- ä¸èƒ½ç›´æ¥è°ƒç”¨ `orderBook.removeOrder()`ï¼Œè¯¥å‡½æ•°åªèƒ½ç”± OrderBook è‡ªå·±è°ƒç”¨
- è¿™æ ·è®¾è®¡é˜²æ­¢äº†ç§»é™¤è¯·æ±‚çš„æŠ¢è·‘ï¼ˆfront-runningï¼‰

## å…³é”®è®¾è®¡è¦ç‚¹

### 1. å…¬å¹³æ€§ä¿è¯

**é—®é¢˜**: å¦‚ä½•é˜²æ­¢æŠ¢å…ˆäº¤æ˜“(Front-running)ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**:
- æ‰€æœ‰è®¢å•å¿…é¡»å…ˆåœ¨Sequencerä¸­æ’é˜Ÿ
- OrderBookåªæ¥å—é˜Ÿåˆ—å¤´éƒ¨çš„è®¢å•
- æŒ‰ç…§åŒºå—æ—¶é—´æˆ³çš„ä¸¥æ ¼é¡ºåºå¤„ç†

### 2. Gasä¼˜åŒ–

**é—®é¢˜**: é“¾ä¸Šæ’åºGasæˆæœ¬é«˜

**è§£å†³æ–¹æ¡ˆ**:
- é“¾ä¸‹è®¡ç®—æœ€ä¼˜æ’å…¥ä½ç½®
- é“¾ä¸ŠåªéªŒè¯ä½ç½®æ˜¯å¦æ­£ç¡®
- é¿å…é“¾ä¸Šéå†æŸ¥æ‰¾

### 3. æ’å…¥ä½ç½®éªŒè¯

**Askåˆ—è¡¨ï¼ˆå–å•ï¼‰** - ä»·æ ¼é€’å¢:
```
éªŒè¯: å‰ä¸€ä¸ªä»·æ ¼ <= æ–°ä»·æ ¼ <= åä¸€ä¸ªä»·æ ¼
```

**Bidåˆ—è¡¨ï¼ˆä¹°å•ï¼‰** - ä»·æ ¼é€’å‡:
```
éªŒè¯: å‰ä¸€ä¸ªä»·æ ¼ >= æ–°ä»·æ ¼ >= åä¸€ä¸ªä»·æ ¼
```

### 4. è®¢å•IDç®¡ç†

- Sequencerç”Ÿæˆå…¨å±€å”¯ä¸€çš„è®¢å•ID
- OrderBookä½¿ç”¨ç›¸åŒçš„è®¢å•ID
- ç¡®ä¿è®¢å•åœ¨ä¸¤ä¸ªåˆçº¦é—´çš„ä¸€è‡´æ€§

## æŸ¥è¯¢åŠŸèƒ½

### è·å–è®¢å•ç°¿æ·±åº¦
```solidity
(uint256[] memory prices, uint256[] memory volumes) =
    orderBook.getOrderBookSnapshot(pair, true, 10);  // è·å–10æ¡£å–å•
```

### è·å–æœ€ä¼˜ä»·æ ¼
```solidity
uint256 bestAsk = orderBook.getBestPrice(pair, true);
uint256 bestBid = orderBook.getBestPrice(pair, false);
```

### è·å–å¸‚ä»·å•åˆ—è¡¨
```solidity
(uint256[] memory orderIds, uint256[] memory amounts) =
    orderBook.getMarketOrderSnapshot(pair, true, 10);
```

### æŸ¥çœ‹Sequenceré˜Ÿåˆ—
```solidity
(uint256[] memory orderIds, address[] memory traders, uint256[] memory amounts) =
    sequencer.getQueueSnapshot(20);
```

### è·å–é˜Ÿåˆ—å¤´éƒ¨
```solidity
uint256 headOrderId = sequencer.getHeadOrderId();
```

## å®‰å…¨è€ƒè™‘

1. **æƒé™æ§åˆ¶**:
   - `popOrder()` åªèƒ½ç”±OrderBookè°ƒç”¨
   - `setOrderBook()` å’Œ `setSequencer()` åªèƒ½è®¾ç½®ä¸€æ¬¡

2. **è®¢å•éªŒè¯**:
   - éªŒè¯è®¢å•å¿…é¡»æ˜¯é˜Ÿåˆ—å¤´éƒ¨
   - éªŒè¯è®¢å•ç±»å‹ï¼ˆé™ä»·/å¸‚ä»·ï¼‰
   - éªŒè¯ä»·æ ¼æ’åºè§„åˆ™

3. **æ‰€æœ‰æƒéªŒè¯**:
   - åˆ é™¤è®¢å•æ—¶éªŒè¯ `msg.sender` æ˜¯è®¢å•æ‰€æœ‰è€…

## æ’®åˆå¼•æ“

### æ ¸å¿ƒæ’®åˆå‡½æ•°

#### `matchOrders()` - æ’®åˆé™ä»·å•
```solidity
function matchOrders(
    bytes32 tradingPair,
    uint256 maxIterations  // æœ€å¤§æ’®åˆæ¬¡æ•°ï¼ˆé˜²æ­¢gasè€—å°½ï¼‰
) external returns (uint256 totalTrades)
```

**æ’®åˆé€»è¾‘**:
1. è·å–æœ€ä¼˜ä¹°ä»·ï¼ˆbidHeadï¼‰å’Œæœ€ä¼˜å–ä»·ï¼ˆaskHeadï¼‰
2. æ£€æŸ¥æ˜¯å¦å¯ä»¥æˆäº¤ï¼š`ä¹°ä»· >= å–ä»·`
3. å¦‚æœå¯ä»¥æˆäº¤ï¼Œæ‰§è¡Œäº¤æ˜“
4. é‡å¤ç›´åˆ° `ä¹°ä»· < å–ä»·` æˆ–è¾¾åˆ°æœ€å¤§æ¬¡æ•°

**æˆäº¤ä»·æ ¼**: ä½¿ç”¨å–å•ä»·æ ¼ï¼ˆä»·æ ¼ä¼˜å…ˆåŸåˆ™ï¼‰

**éƒ¨åˆ†æˆäº¤**:
- æ”¯æŒè®¢å•éƒ¨åˆ†æˆäº¤
- æœªå®Œå…¨æˆäº¤çš„è®¢å•ä¿ç•™åœ¨è®¢å•ç°¿ä¸­
- å®Œå…¨æˆäº¤çš„è®¢å•è‡ªåŠ¨ä»è®¢å•ç°¿ç§»é™¤

#### `matchMarketOrders()` - æ’®åˆå¸‚ä»·å•
```solidity
function matchMarketOrders(
    bytes32 tradingPair,
    uint256 maxIterations
) external returns (uint256 totalTrades)
```

**æ’®åˆé€»è¾‘**:
- å¸‚ä»·ä¹°å•ï¼šä¸æœ€ä¼˜å–ä»·ï¼ˆaskHeadï¼‰æ’®åˆ
- å¸‚ä»·å–å•ï¼šä¸æœ€ä¼˜ä¹°ä»·ï¼ˆbidHeadï¼‰æ’®åˆ

#### `matchAll()` - å®Œæ•´æ’®åˆ
```solidity
function matchAll(
    bytes32 tradingPair,
    uint256 maxIterations
) external returns (uint256 limitTrades, uint256 marketTrades)
```

å…ˆæ’®åˆé™ä»·å•ï¼Œå†æ’®åˆå¸‚ä»·å•ã€‚

### æ’®åˆç¤ºä¾‹

```solidity
bytes32 pair = keccak256("ETH/USDC");

// å‡è®¾è®¢å•ç°¿çŠ¶æ€:
// Bid: 2000 (10), 1990 (5)
// Ask: 1995 (8), 2005 (12)

// æ‰§è¡Œæ’®åˆ
uint256 trades = orderBook.matchOrders(pair, 100);

// æ’®åˆç»“æœ:
// - ä¹°å• 2000 ä¸ å–å• 1995 æˆäº¤ 8ä¸ªï¼Œæˆäº¤ä»· 1995
// - ä¹°å• 2000 å‰©ä½™ 2ä¸ªï¼Œç»§ç»­ä¸ å–å• 2005 æˆäº¤ 2ä¸ªï¼Œæˆäº¤ä»· 2005
// - ä¹°å• 1990 < å–å• 2005ï¼Œåœæ­¢æ’®åˆ
//
// æœ€ç»ˆçŠ¶æ€:
// Bid: 1990 (5)
// Ask: 2005 (10)
// ç¡®ä¿äº†: æœ€é«˜ä¹°ä»·(1990) < æœ€ä½å–ä»·(2005) âœ“
```

### æ’®åˆäº‹ä»¶

#### Tradeäº‹ä»¶
```solidity
event Trade(
    bytes32 indexed tradingPair,
    uint256 indexed buyOrderId,
    uint256 indexed sellOrderId,
    address buyer,
    address seller,
    uint256 price,      // æˆäº¤ä»·æ ¼
    uint256 amount      // æˆäº¤æ•°é‡
);
```

#### OrderFilledäº‹ä»¶
```solidity
event OrderFilled(
    bytes32 indexed tradingPair,
    uint256 indexed orderId,
    uint256 filledAmount,    // æœ¬æ¬¡æˆäº¤æ•°é‡
    bool isFullyFilled       // æ˜¯å¦å®Œå…¨æˆäº¤
);
```

### æ’®åˆä¿è¯

1. **ä»·æ ¼å•è°ƒæ€§**: æ’®åˆåç¡®ä¿ `æœ€é«˜ä¹°ä»· < æœ€ä½å–ä»·`
2. **ä»·æ ¼-æ—¶é—´ä¼˜å…ˆ**:
   - ä»·æ ¼ä¼˜å…ˆï¼šæœ€ä¼˜ä»·æ ¼ä¼˜å…ˆæ’®åˆ
   - æ—¶é—´ä¼˜å…ˆï¼šåŒä»·æ ¼å±‚çº§å†…æŒ‰FIFOé¡ºåº
3. **éƒ¨åˆ†æˆäº¤**: æ”¯æŒè®¢å•éƒ¨åˆ†æˆäº¤ï¼Œæœªæˆäº¤éƒ¨åˆ†ä¿ç•™
4. **è‡ªåŠ¨æ¸…ç†**: å®Œå…¨æˆäº¤çš„è®¢å•è‡ªåŠ¨ç§»é™¤
5. **Gasæ§åˆ¶**: é€šè¿‡maxIterationså‚æ•°æ§åˆ¶å•æ¬¡æ‰§è¡Œçš„æ’®åˆæ¬¡æ•°

### æ’®åˆæµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  matchOrders()  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ bidHeadä»·æ ¼ â”‚ >= â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   >= ?      â”‚    â”‚ askHeadä»·æ ¼ â”‚
   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ Yes
         â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  æ‰§è¡Œäº¤æ˜“         â”‚
   â”‚  - è®¡ç®—æˆäº¤é‡     â”‚
   â”‚  - æ›´æ–°filledAmountâ”‚
   â”‚  - æ›´æ–°totalVolumeâ”‚
   â”‚  - emit Tradeäº‹ä»¶ â”‚
   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  æ£€æŸ¥è®¢å•çŠ¶æ€     â”‚
   â”‚  å®Œå…¨æˆäº¤?       â”‚
   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ Yes
         â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  ç§»é™¤è®¢å•         â”‚
   â”‚  - ä»é“¾è¡¨ç§»é™¤     â”‚
   â”‚  - åˆ é™¤è®¢å•æ•°æ®   â”‚
   â”‚  - æ¸…ç†ç©ºä»·æ ¼å±‚çº§ â”‚
   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
   ç»§ç»­ä¸‹ä¸€è½®æ’®åˆ...
```

## Rust Matcher å¼•æ“

### æ¦‚è¿°

åŸºäº Rust çš„é“¾ä¸‹æ’®åˆå¼•æ“ï¼Œé€šè¿‡**äº‹ä»¶é©±åŠ¨**æ–¹å¼å®æ—¶åŒæ­¥é“¾ä¸Šè®¢å•ç°¿çŠ¶æ€ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡æ‹Ÿå™¨è®¡ç®—æ­£ç¡®çš„æ’å…¥ä½ç½®ï¼Œå¹¶æ‰¹é‡æäº¤åˆ° OrderBookã€‚

### æ ¸å¿ƒåŠŸèƒ½

- ğŸ”„ **äº‹ä»¶é©±åŠ¨åŒæ­¥**: é€šè¿‡é“¾ä¸Šäº‹ä»¶å®æ—¶æ›´æ–°æœ¬åœ°è®¢å•ç°¿çŠ¶æ€
- ğŸ¯ **ç²¾ç¡®æ¨¡æ‹Ÿ**: `OrderBookSimulator` ä¸¥æ ¼é•œåƒé“¾ä¸Šè®¢å•ç°¿ç»“æ„
- ğŸ“¦ **æ‰¹é‡å¤„ç†**: æ‰¹é‡è°ƒç”¨ `batchProcessRequests` èŠ‚çœ gas æˆæœ¬
- âš¡ **æ·±æ‹·è´éš”ç¦»**: ä½¿ç”¨æ·±æ‹·è´éš”ç¦»æ¨¡æ‹Ÿè®¡ç®—ï¼Œä¿è¯çŠ¶æ€ä¸€è‡´æ€§
- ğŸ“Š **å®æ—¶ç›‘æ§**: å®Œæ•´çš„æ—¥å¿—ç³»ç»Ÿï¼Œç›‘æ§åŒ¹é…å¼•æ“è¿è¡ŒçŠ¶æ€

### æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Matcher                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ StateSynchronizerâ”‚    â”‚      MatchingEngine             â”‚ â”‚
â”‚  â”‚                 â”‚    â”‚                                 â”‚ â”‚
â”‚  â”‚ â€¢ å¯åŠ¨æ—¶åŒæ­¥çŠ¶æ€  â”‚    â”‚ â€¢ å®šæœŸå¤„ç†è¯·æ±‚é˜Ÿåˆ—               â”‚ â”‚
â”‚  â”‚ â€¢ ç›‘å¬é“¾ä¸Šäº‹ä»¶   â”‚    â”‚ â€¢ è®¡ç®— insertAfterPrice         â”‚ â”‚
â”‚  â”‚ â€¢ æ›´æ–° GlobalStateâ”‚   â”‚ â€¢ æ‰§è¡Œæ‰¹é‡äº¤æ˜“                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚           â”‚                          â”‚                       â”‚
â”‚           â–¼                          â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    GlobalState                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ queued_requests  â”‚  â”‚      orderbook             â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ (Sequenceré˜Ÿåˆ—)   â”‚  â”‚   (OrderBookSimulator)     â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®è®¾è®¡

1. **äº‹ä»¶é©±åŠ¨çŠ¶æ€æ›´æ–°**: `GlobalState.orderbook` åªé€šè¿‡é“¾ä¸Šäº‹ä»¶æ›´æ–°ï¼Œä¿è¯æœ¬åœ°ä¸é“¾ä¸Šä¸¥æ ¼ä¸€è‡´
2. **æ·±æ‹·è´éš”ç¦»æ¨¡æ‹Ÿ**: `clone_orderbook()` åˆ›å»ºå®Œæ•´æ·±æ‹·è´ï¼Œæ¨¡æ‹Ÿè®¡ç®—ä¸å½±å“åŸå§‹çŠ¶æ€
3. **è¯·æ±‚é˜Ÿåˆ—ç®¡ç†**: åªæœ‰äº¤æ˜“æˆåŠŸåæ‰ç§»é™¤è¯·æ±‚ï¼Œå¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•

### å¿«é€Ÿæµ‹è¯•

```bash
# 1. å¯åŠ¨ Anvil
anvil --block-time 1

# 2. éƒ¨ç½²åˆçº¦
forge script script/Deploy.s.sol --broadcast --rpc-url http://127.0.0.1:8545

# 3. ä¸‹æµ‹è¯•è®¢å•
forge script script/PlaceTestOrders.s.sol --broadcast --rpc-url http://127.0.0.1:8545

# 4. è¿è¡Œ Matcher
cd matcher && cargo run -- --log-level debug
```

è¯¦ç»†æ–‡æ¡£ï¼š
- ğŸ“– [Matcher å¿«é€Ÿå¼€å§‹](doc/QUICKSTART_MATCHER.md)
- ğŸ“– [Matcher ä½¿ç”¨æŒ‡å—](matcher/USAGE.md)
- ğŸ“– [Matcher æ¶æ„è¯´æ˜](matcher/ARCHITECTURE.md)

### æ•°æ®æµ

```
é“¾ä¸Šäº‹ä»¶                    æœ¬åœ°çŠ¶æ€                    äº¤æ˜“æ‰§è¡Œ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PlaceOrderRequested â”€â”€â”€â”€â”€â”€â–º queued_requests.add()
                                   â”‚
                                   â–¼
                          MatchingEngine.process_batch()
                                   â”‚
                          clone_orderbook() â”€â”€â–º æ·±æ‹·è´
                                   â”‚
                          simulate_insert() â”€â”€â–º è®¡ç®— insertAfterPrice
                                   â”‚
                          execute_batch() â”€â”€â”€â–º batchProcessRequests tx
                                   â”‚
                                   â–¼
OrderInserted â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º orderbook.orders.insert()
PriceLevelCreated â”€â”€â”€â”€â”€â”€â”€â”€â–º orderbook.price_levels.insert()
OrderFilled â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º orderbook.orders.update()
OrderRemoved â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º orderbook.orders.remove()
```

## æœªæ¥æ‰©å±•

- [x] è®¢å•æ’®åˆå¼•æ“
- [x] éƒ¨åˆ†æˆäº¤æ”¯æŒ
- [x] Rust Matcher å¼•æ“
- [x] æ‰¹é‡è®¢å•å¤„ç†
- [ ] è®¢å•è¿‡æœŸæ—¶é—´
- [ ] æ‰‹ç»­è´¹æœºåˆ¶
- [ ] MEVä¿æŠ¤æœºåˆ¶
- [ ] ä»·æ ¼é¢„è¨€æœºé›†æˆ

## é¡¹ç›®ç»“æ„

```
orderbook/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ Sequencer.sol          # è®¢å•æ’åºå™¨
â”‚   â”œâ”€â”€ OrderBook.sol          # è®¢å•ç°¿æ ¸å¿ƒ
â”‚   â””â”€â”€ Account.sol            # è´¦æˆ·å’Œèµ„é‡‘ç®¡ç†
â”œâ”€â”€ script/                    # Foundry éƒ¨ç½²è„šæœ¬
â”‚   â”œâ”€â”€ Deploy.s.sol          # åˆçº¦éƒ¨ç½²
â”‚   â””â”€â”€ PlaceTestOrders.s.sol # æµ‹è¯•è®¢å•è„šæœ¬
â”œâ”€â”€ test/                      # Foundry æµ‹è¯•
â”‚   â””â”€â”€ OrderBook.t.sol       # å•å…ƒæµ‹è¯•
â”œâ”€â”€ matcher/                   # Rust Matcher å¼•æ“
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ main.rs               # ä¸»å…¥å£
â”‚   â”‚   â”œâ”€â”€ config.rs             # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ contracts.rs          # åˆçº¦ç»‘å®š
â”‚   â”‚   â”œâ”€â”€ types.rs              # ç±»å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ state.rs              # GlobalState çŠ¶æ€ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ sync.rs               # çŠ¶æ€åŒæ­¥ + äº‹ä»¶ç›‘å¬
â”‚   â”‚   â”œâ”€â”€ matcher.rs            # åŒ¹é…å¼•æ“
â”‚   â”‚   â””â”€â”€ orderbook_simulator.rs # è®¢å•ç°¿æ¨¡æ‹Ÿå™¨
â”‚   â”œâ”€â”€ abi/                  # åˆçº¦ ABI
â”‚   â””â”€â”€ config.toml           # é…ç½®æ–‡ä»¶
â”œâ”€â”€ doc/                       # æ–‡æ¡£ç›®å½•
â”‚   â”œâ”€â”€ QUICKSTART_MATCHER.md # Matcher å¿«é€Ÿå¼€å§‹
â”‚   â”œâ”€â”€ TESTING_GUIDE.md      # æµ‹è¯•æŒ‡å—
â”‚   â”œâ”€â”€ DEPLOYMENT.md         # éƒ¨ç½²æŒ‡å—
â”‚   â””â”€â”€ ...                   # å…¶ä»–æ–‡æ¡£
â””â”€â”€ deployments.json          # éƒ¨ç½²åœ°å€
```

## è®¸å¯è¯

MIT License
